name: Build Android APK

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
            build-essential \
            git \
            openjdk-17-jdk \
            unzip \
            zip \
            wget \
            curl \
            lib32stdc++6 \
            lib32z1

    - name: Install Buildozer and dependencies
      run: |
        pip install --upgrade pip
        pip install buildozer cython
        # 验证安装
        echo "Buildozer version:"
        buildozer --version
        echo "Cython version:"
        cython --version

    - name: Create buildozer.spec
      run: |
        # 检查是否已经存在 buildozer.spec 文件
        if [ ! -f "buildozer.spec" ]; then
            echo "buildozer.spec 文件不存在，初始化新文件："
            buildozer init
        else
            echo "buildozer.spec 文件已存在，跳过初始化："
        fi
        # 显示当前文件内容
        cat buildozer.spec
        # 修改配置（移除中文注释）
        sed -i 's/title = My Application/title = 极简日历/' buildozer.spec
        sed -i 's/package.name = myapp/package.name = calendarapk/' buildozer.spec
        sed -i 's/package.domain = org.test/package.domain = org.calendar/' buildozer.spec
        sed -i 's/requirements = python3,kivy/requirements = python3,kivy,kivymd/' buildozer.spec
        sed -i 's/android.api = 31/android.api = 33/' buildozer.spec
        sed -i 's/android.ndk = 25b/android.ndk = 25b/' buildozer.spec
        sed -i 's/android.sdk = 24/android.sdk = 33/' buildozer.spec
        sed -i 's/android.permissions = /android.permissions = INTERNET/' buildozer.spec
        # 显示修改后的文件内容
        echo "修改后的 buildozer.spec 文件内容："
        cat buildozer.spec

    - name: Install and configure Android SDK
      run: |
        # 创建 Android SDK 目录
        ANDROID_HOME=$HOME/.buildozer/android/platform/android-sdk
        mkdir -p $ANDROID_HOME/cmdline-tools
        
        # 下载并安装 Android SDK Command Line Tools
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip -O cmdline-tools.zip
        unzip -q cmdline-tools.zip -d $ANDROID_HOME/cmdline-tools
        
        # 重命名目录
        mv $ANDROID_HOME/cmdline-tools/cmdline-tools $ANDROID_HOME/cmdline-tools/latest
        
        # 创建旧的 tools/bin 目录结构并添加符号链接
        mkdir -p $ANDROID_HOME/tools/bin
        ln -s $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager $ANDROID_HOME/tools/bin/sdkmanager
        ln -s $ANDROID_HOME/cmdline-tools/latest/bin/avdmanager $ANDROID_HOME/tools/bin/avdmanager
        
        # 设置环境变量
        export ANDROID_HOME=$ANDROID_HOME
        export ANDROID_SDK_ROOT=$ANDROID_HOME
        export PATH=$PATH:$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$ANDROID_HOME/tools/bin
        
        # 创建许可证目录并接受许可证
        mkdir -p $ANDROID_HOME/licenses
        echo -e "\n8933bad161af4178b1185d1a37fbf41ea5269c55" > $ANDROID_HOME/licenses/android-sdk-license
        echo -e "\n84831b9409646a918e30573bab4c9c91346d8abd" > $ANDROID_HOME/licenses/android-sdk-preview-license
        
        # 安装必要的 SDK 组件
        yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "platform-tools" "platforms;android-33" "build-tools;33.0.0" --sdk_root=$ANDROID_HOME
        
        # 验证安装
        echo "Android SDK installed successfully"
        echo "sdkmanager path:"
        which sdkmanager
        echo "Old sdkmanager path exists:"
        ls -la $ANDROID_HOME/tools/bin/sdkmanager
        echo "Platform tools installed:"
        ls -la $ANDROID_HOME/platform-tools/

    - name: Build APK
      run: |
        # 创建 assets 目录
        mkdir -p assets
        
        # 设置环境变量
        export ANDROID_HOME=$HOME/.buildozer/android/platform/android-sdk
        export ANDROID_SDK_ROOT=$ANDROID_HOME
        export PATH=$PATH:$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$ANDROID_HOME/tools/bin
        
        # 显示环境信息
        echo "Environment variables:"
        printenv | grep -E "ANDROID|JAVA"
        echo "Current directory:"
        pwd
        echo "Directory contents:"
        ls -la
        echo "Buildozer version:"
        buildozer --version
        
        # 构建 APK（添加详细日志）
        echo "Building APK with verbose output..."
        buildozer android debug -v

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: |
          bin/*.apk
          .buildozer/android/platform/android-sdk*/logs
          buildozer.spec
      if: always()