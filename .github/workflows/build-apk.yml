name: Build Android APK

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Build APK
      run: |
        # 创建一个脚本文件来处理构建过程
        cat > build.sh << 'EOF'
        #!/bin/bash
        
        # 切换到工作目录
        cd /app
        
        # 安装 expect 工具
        apt-get update && apt-get install -y expect
        
        # 创建一个 expect 脚本来自动响应 root 用户提示
        cat > build_with_expect.exp << 'EXPECTEOF'
        #!/usr/bin/expect -f
        
        # 设置超时时间
        set timeout -1
        
        # 执行 buildozer 命令
        spawn buildozer android debug
        
        # 等待 root 用户提示
        expect "Are you sure you want to continue [y/n]? " {
            # 发送 "y" 并回车
            send "y\r"
        }
        
        # 等待构建完成
        expect eof
        EXPECTEOF
        
        # 给脚本添加执行权限
        chmod +x build_with_expect.exp
        
        # 运行 expect 脚本
        expect build_with_expect.exp
        EOF
        
        # 给脚本添加执行权限
        chmod +x build.sh
        
        # 使用 Docker 运行构建脚本
        docker run --rm -v "${{ github.workspace }}:/app" \
        --privileged \
        kivy/buildozer:latest \
        bash /app/build.sh
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: apk
        path: bin/*