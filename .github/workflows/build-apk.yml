name: Build Android APK

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Create minimal project structure
      run: |
        # 创建基本的项目文件
        echo "from kivy.app import App
from kivy.uix.label import Label
from kivy.uix.boxlayout import BoxLayout
from kivy.uix.button import Button
from datetime import datetime

class CalendarApp(App):
    def build(self):
        layout = BoxLayout(orientation='vertical', padding=50, spacing=20)
        
        # 显示当前日期
        current_date = datetime.now().strftime('%Y年%m月%d日')
        date_label = Label(text=current_date, font_size=40, bold=True)
        layout.add_widget(date_label)
        
        # 显示星期
        weekdays = ['周日', '周一', '周二', '周三', '周四', '周五', '周六']
        weekday = weekdays[datetime.now().weekday()]
        weekday_label = Label(text=weekday, font_size=30)
        layout.add_widget(weekday_label)
        
        # 添加一个按钮
        button = Button(text='刷新日期', font_size=20, size_hint=(0.5, 0.2), pos_hint={'center_x': 0.5})
        button.bind(on_press=self.refresh_date)
        layout.add_widget(button)
        
        return layout
    
    def refresh_date(self, instance):
        # 这里可以添加刷新日期的逻辑
        pass

if __name__ == '__main__':
    CalendarApp().run()" > main.py

        # 创建 buildozer.spec
        echo "[app]
title = 极简日历
package.name = calendarapk
package.domain = org.calendar
source.dir = .
source.include_exts = py,png,jpg,kv,atlas
version = 0.1
requirements = python3,kivy
orientation = portrait
osx.python_version = 3
osx.kivy_version = 2.0.0
fullscreen = 0
android.api = 33
android.sdk = 33
android.ndk = 25b
android.arch = armeabi-v7a
android.buildtools = 33.0.0
android.use_aapt2 = True
android.permissions = INTERNET
services =
[buildozer]
log_level = 2
warn_on_root = 1
[app:debug]
android.debug = True" > buildozer.spec

    - name: Build APK with Docker
      run: |
        # 运行 buildozer 容器
        docker run --name calendarapk-builder -v $(pwd):/app kivy/buildozer:latest bash -c "cd /app && buildozer android debug"
        
        # 复制构建结果
        mkdir -p output
        docker cp calendarapk-builder:/app/bin/. output/
        
        # 显示构建结果
        ls -la output/
        
        # 清理
        docker rm calendarapk-builder

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: |
          output/*.apk
          buildozer.spec
      if: always()