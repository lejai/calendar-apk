name: Build Android APK

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-20.04
    steps:
    - uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        # 更新包列表
        sudo apt-get update -y
        
        # 安装必要的系统依赖
        sudo apt-get install -y \
            python3-pip \
            python3-dev \
            build-essential \
            git \
            wget \
            curl \
            unzip \
            openjdk-11-jdk \
            ant
        
        # 更新 pip
        pip3 install --upgrade pip
        
        # 安装 Python 依赖
        pip3 install cython buildozer
    
    - name: Modify Buildozer to skip root check
      run: |
        # 找到 Buildozer 的安装路径
        BUILDOZER_PATH=$(pip3 show buildozer | grep Location | cut -d' ' -f2)
        echo "Buildozer path: $BUILDOZER_PATH"
        
        # 修改 Buildozer 的源代码，跳过 root 用户检查
        BUILDOZER_INIT_FILE="$BUILDOZER_PATH/buildozer/__init__.py"
        echo "Modifying $BUILDOZER_INIT_FILE"
        
        # 在 check_root 方法开头添加 return 语句
        sed -i 's/def check_root(self):/def check_root(self):\n        return/' "$BUILDOZER_INIT_FILE"
        
        # 验证修改是否成功
        grep -A 5 "def check_root" "$BUILDOZER_INIT_FILE"
    
    - name: Build APK
      run: |
        # 构建 APK
        buildozer android debug
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: apk
        path: bin/*